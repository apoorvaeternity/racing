<!DOCTYPE html>
<html lang="en">
<head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
</head>

<body>
<p id="demo"></p>
<canvas id="gameCanvas" width="800" height="600"></canvas>
<script>
    // carPic: Image object of the car
    var carPic = document.createElement("img");
    var checkeredPic = document.createElement("img");
    var asphaltPic = document.createElement("img");
    var carPicLoaded = false;
    var checkeredPicLoaded =false;
    var asphaltPicLoaded = false;
    var carX = 75;
    var carY = 75;
    var carAng = 0;
    var carSpeed = 0;
    var canvas, canvasContext;
    var carWidth = 40;
    var carHeight = 40;
    const KEY_LEFT_ARROW = 37;
    const KEY_UP_ARROW = 38;
    const KEY_RIGHT_ARROW = 39;
    const KEY_DOWN_ARROW = 40;

    var keyHeld_Gas = false;
    var keyHeld_Reverse = false;
    var keyHeld_TurnLeft = false;
    var keyHeld_TurnRight = false;


    const TRACK_W = 40; // Setting the track width
    const TRACK_H = 40; // Setting the track height
    const TRACK_GAP = 0;
    const TRACK_COLS = 20;
    const TRACK_ROWS = 15;
    var trackGrid =
           [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
            1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
            1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
            1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1,
            1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1,
            1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 0, 0, 1,
            1, 0, 0, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1,
            1, 0, 0, 1, 0, 0, 0, 0, 0, 1, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1,
            1, 0, 0, 1, 0, 0, 1, 0, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1,
            1, 0, 0, 1, 0, 0, 1, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1,
            1, 2, 2, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 1,
            1, 0, 0, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1,
            1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1,
            1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1,
            1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1];

    //This function handles key press events.

    function keyPressed(evt) {
        if (evt.keyCode == KEY_LEFT_ARROW) {
            keyHeld_TurnLeft = true;
        }
        if (evt.keyCode == KEY_RIGHT_ARROW) {
            keyHeld_TurnRight = true;
        }
        if (evt.keyCode == KEY_UP_ARROW) {
            keyHeld_Gas = true;
        }
        if (evt.keyCode == KEY_DOWN_ARROW) {
            keyHeld_Reverse = true;
        }
    }

    //This function handles key release events.
    function keyReleased(evt) {
        if (evt.keyCode == KEY_LEFT_ARROW) {
            keyHeld_TurnLeft = false;
        }
        if (evt.keyCode == KEY_RIGHT_ARROW) {
            keyHeld_TurnRight = false;
        }
        if (evt.keyCode == KEY_UP_ARROW) {
            keyHeld_Gas = false;
        }
        if (evt.keyCode == KEY_DOWN_ARROW) {
            keyHeld_Reverse = false;
        }
        evt.preventDefault();
    }
    var  interval;
    // After the window has loaded we will perform various operations
    window.onload = function () {
        // Getting the canvas element
        canvas = document.getElementById('gameCanvas');
        canvasContext = canvas.getContext('2d');
        // Setting the number of frames per second to render.
        var framesPerSecond = 30;
        interval = setInterval(updateAll, 1000 / framesPerSecond);

        // Adding keydown and keyup event listleners.
        document.addEventListener('keydown', keyPressed);
        document.addEventListener('keyup', keyReleased);

        // After the picture has loaded update the carPicLoaded variable.
        carPic.onload = function () {
            carPicLoaded = true;
        }
        // Here we set the source path of the car image.
        carPic.src = "assets/Car.png";

        checkeredPic.onload = function () {
            checkeredPicLoaded=  true;
        }
        checkeredPic.src = "assets/checkered.png";
        asphaltPic.onload = function () {
            asphaltPicLoaded=  true;
        }
        asphaltPic.src = "assets/asphalt.png";

        carReset();
    }

    // This is to update the canvas elements.
    function updateAll() {
        moveAll();
        drawAll();
    }

    //
    function carReset() {
        for (var eachRow = 0; eachRow < TRACK_ROWS; eachRow++) {
            for (var eachCol = 0; eachCol < TRACK_COLS; eachCol++) {
                var arrayIndex = TRACK_COLS * eachRow + eachCol;
                if (trackGrid[arrayIndex] == 2) {
                    carAng = -Math.PI / 2;
                    carX = eachCol * TRACK_W + TRACK_W / 2;
                    carY = eachRow * TRACK_H + TRACK_H / 2;
                }
            }
        }
    }

    // This function will handle car movement based on key press events.
    function carMove() {
        carSpeed *= .97
        if (keyHeld_Gas) {
            carSpeed += .3;
        }
        if (keyHeld_Reverse) {
            carSpeed -= .3;
        }
        if (keyHeld_TurnLeft) {
            carAng -= .04;
        }
        if (keyHeld_TurnRight) {
            carAng += .04;
        }


        carX += Math.cos(carAng) * carSpeed;
        carY += Math.sin(carAng) * carSpeed;
    }


    function isTrackAtColRow(col, row) {
        if (col >= 0 && col < TRACK_COLS && row >= 0 & row < TRACK_ROWS) {
            var trackIndexUnderCar = rowColToArrayIndex(col, row);
            return (trackGrid[trackIndexUnderCar] == 1);
        }
        else {
            return false;
        }
    }

    //
    function carTrackHandling() {
        var carTrackCol = Math.floor(carX / TRACK_W);
        var carTrackRow = Math.floor(carY / TRACK_H);

        if (carTrackCol >= 0 && carTrackCol < TRACK_COLS && carTrackRow >= 0 && carTrackRow < TRACK_ROWS) {

            if (isTrackAtColRow(carTrackCol, carTrackRow)) {
                carX -= Math.cos(carAng) * carSpeed;
                carY -= Math.sin(carAng) * carSpeed;
                carSpeed *= -.5;
            }
        }
    }

    function moveAll() {
        carMove();
        carTrackHandling();
    }

    function rowColToArrayIndex(col, row) {
        return col + TRACK_COLS * row;
    }

    function drawTracks() {

        for (var eachRow = 0; eachRow < TRACK_ROWS; eachRow++) {
            for (var eachCol = 0; eachCol < TRACK_COLS; eachCol++) {

                var arrayIndex = TRACK_COLS * eachRow + eachCol;
                if (trackGrid[arrayIndex] == 0) {
                    canvasContext.drawImage(asphaltPic,TRACK_W * eachCol, TRACK_H * eachRow, 40,40);
                }
                if (trackGrid[arrayIndex]==2){
                    if(checkeredPicLoaded){
                    canvasContext.drawImage(checkeredPic,TRACK_W * eachCol, TRACK_H * eachRow,40,40);
                    }
                }
            }
        }
    }

    function drawAll() {
        colorRect(0, 0, canvas.width, canvas.height, 'black');
        drawTracks();
        if (carPicLoaded) {
            // Draw the car
            drawBitmapCenteredWithRotation(carPic, carX, carY, carAng);
        }


    }

    function drawBitmapCenteredWithRotation(useBitmap, atX, atY, withAng) {
        canvasContext.save();
        canvasContext.translate(atX, atY);
        canvasContext.rotate(withAng);
        canvasContext.drawImage(useBitmap, -carWidth / 2, -carHeight / 2,carWidth,carHeight);
        canvasContext.restore();
    }

    function colorRect(topLeftX, topLeftY, boxWidth, boxHeight, fillColor) {
        canvasContext.fillStyle = fillColor;
        canvasContext.fillRect(topLeftX, topLeftY, boxWidth, boxHeight, fillColor);
    }


    function colorText(showWords, textX, textY, fillColor , maxWidth) {
        canvasContext.fillStyle = fillColor;
        canvasContext.font = "70px Georgia";
        canvasContext.fillText(showWords, textX, textY);
    }

    // Set the date we're counting down to
    //add 5 minutes to the current date
    var countDownDate = new Date().getTime()+ 1*60000;
    // Update the count down every 1 second
    var x = setInterval(function() {

        // Get todays date and time
        var now = new Date().getTime();

        // Find the distance between now an the count down time
        var distance = countDownDate - now;

        // Time calculations for days, hours, minutes and seconds
        var days = Math.floor(distance / (1000 * 60 * 60 * 24));
        var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        var seconds = Math.floor((distance % (1000 * 60)) / 1000);

        // Output the result in an element with id="demo"
        document.getElementById("demo").innerHTML =  minutes + "m " + seconds + "s ";


        // If the count down is over, write some text
        if (distance < 0) {
            clearInterval(x);
            colorText("Game Over",canvas.width/2-100,canvas.height/2-50,'red', 150);
            clearInterval(interval);
        }else{

        }
    }, 1000);
</script>
</body>
</html>
